angular.module("koast",["koast-user","koast-resource"]).factory("koast",["_koastUser","_koastResourceGetter","$log",function(e,t,n){"use strict";var r={},o=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return r.user=e,o.forEach(function(e){r[e]=t[e]}),r.init=function(t){n.info("Initializing koast."),e.init(t)},r}]),angular.module("koast-persona",[]).factory("_koastPersona",["$http","$q","$interval","$location","$log",function(e,t,n,r,o){"use strict";function a(){var e,r=window.document,o=r.getElementsByTagName("head")[0],a=r.createElement("script"),i=t.defer();return a.type="text/javascript",a.async=!0,a.src="https://login.persona.org/include.js",o.appendChild(a),e=n(function(){window.navigator.id&&(i.resolve(),n.cancel(e))},50),i.promise}function i(t){o.debug("verifyAssertion:");var n=r.absUrl().split("/").slice(0,3).join("/")+"/",a={assertion:t,audience:n};o.info("audience:",n);var i={timeout:5e3};return e.post("/auth/browserid",a,i).then(function(e){return o.debug("Response:",e),e.data}).then(null,function(e){throw"object"==typeof e&&e.headers?(o.error("Persona verification timed out."),new Error("Persona verification timed out.")):(o.error("Error verifying Persona assertion:",e.toString()),o.error(e.stack),e)})}var u={},s=!1,c=t.defer();return u.initiateSignIn=function(e){e||(e={}),o.debug("signIn"),s=!0,navigator.id.request({siteName:e.siteTitle,oncancel:function(){o.info("Persona login cancelled by user.")}})},u.initiateSignOut=function(){s=!0,navigator.id.logout()},u.init=function(e){return a().then(function(){o.debug("navigator.id.watch added"),navigator.id.watch({loggedInUser:null,onlogin:function(t){s&&i(t).then(function(t){e.onSignIn(t)},o.error)},onlogout:function(){s&&e.onSignOut()},onready:function(){c.resolve()}})}).then(null,o.error),c.promise},u.whenReady=function(){return c.promise},u}]),angular.module("koast-resource",["koast-user"]).factory("_KoastServerHelper",["_koastUser",function(e){"use strict";var t={};return t.addAuthHeaders=function(t){e.isSignedIn&&(t["koast-auth-token"]=e.meta.authToken,t["koast-auth-token-timestamp"]=e.meta.timestamp,t["koast-user"]=angular.toJson(e.data))},t}]).factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(e,t,n,r){"use strict";function o(e,t,n){var r,o=this;if(n.useEnvelope){if(r=t.data,!r)throw new Error("Client expects an envelope, but server did not send it properly.")}else r=t;return _.keys(r).forEach(function(e){o[e]=r[e]}),n.useEnvelope&&Object.defineProperty(this,"can",{get:function(){return t.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return e}}),this}return o.prototype.save=function(){var t=this._endpoint.makeGetUrl(this),r={};return e.addAuthHeaders(r),n.put(t,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var t=this._endpoint.makeGetUrl(this);r.debug("delete url:",t);var o={};return e.addAuthHeaders(o),n.delete(t,{headers:o})},o}]).factory("_KoastEndpoint",[function(){"use strict";function e(e,t,n,r){var o=this;o.prefix=e,o.handle=t,o.template=n,o.options=_.clone(r)}function t(e,t){return t?e.replace(/:([-_a-zA-Z]*)/g,function(e,n){var r=t[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return t[n]}):""}return e.prototype.makePostUrl=function(){return this.prefix+this.handle},e.prototype.makeGetUrl=function(e){return this.makePostUrl()+"/"+t(this.template,e)},e}]).factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log",function(e,t,n,r,o,a){"use strict";function i(t,n){var r=_.map(t,function(t){return new e(n.endpoint,t,n)});return n.singular&&(0===r.length?r=null:r.length>1?(a.warn("Expected a singular resource, got "+r.length),r=r[0]):r=r[0]),r}function u(e,n,o,a){var u=l[e],s={},c={},d={params:o,headers:s};if(c=angular.extend(c,u.options),c=angular.extend(c,a),c.endpoint=u,!u)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),r.get(u.makeGetUrl(n),d).then(function(e){return i(e.data,c)})}function s(e,n,a){var i=o.defer(),u=l[e],s={};if(a=a||{},!u)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),r.post(u.makePostUrl(),n,{headers:s}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}var c={},d={},l={};return c.setApiUriPrefix=function(e,t){t=t||"_",d[t]=e},c.getResource=function(e,t){return u(e,t,null,{singular:!0})},c.createResource=function(e,t){return s(e,t).then(null,a.error)},c.queryForResources=function(e,t){return u(e,null,t)},c.addEndpoint=function(e,t,r){r=r||{};var o=r.server||"_",a=d[o];if(!a)throw new Error("No URI prefix defined for server "+o);var i=new n(a,e,t,r);if(l[e])throw new Error("An endpoint with this handle was already defined: "+e);l[e]=i},c}]),angular.module("koast-user",[]).factory("_koastOauth",["$window","$location","$log",function(e,t){"use strict";function n(e,t){return o+"/auth/"+e+"?next="+encodeURIComponent(t)}var r={},o=t.absUrl().split("/").slice(0,3).join("/")+"/";return r.initiateAuthentication=function(r){var o=n(r,t.absUrl());e.location.replace(o)},r.setBaseUrl=function(e){o=e},r.makeRequestURL=function(e){return e||(e=""),o+e},r}]).factory("_koastUser",["_koastOauth","$log","$timeout","$http","$window","$q",function(e,t,n,r,o){"use strict";function a(e){var r=f.debug.delay;return r?(t.debug("Delayng for "+r+" msec."),n(function(){return e},r)):e}function i(e){var t=e.data;return t.isAuthenticated&&(f.data=t.data,f.meta=t.meta),f.isAuthenticated=t.isAuthenticated,t.isAuthenticated}function u(e){return e.data&&e.data.username?(f.data=e.data,f.isAuthenticated=!0,f.meta=e.meta):(f.data={},f.isAuthenticated=!1),f.isAuthenticated}function s(e){return t.debug("isAuthenticated?",e),e&&!f.meta.isRegistered&&d?n(d,0).then(function(){return e}):(f.isReady=!0,e)}function c(t){return r.get(t||e.makeRequestURL("/auth/user")).then(a).then(i).then(s)}var d,l,f={isAuthenticated:!1,data:{},meta:{}};return f.initiateOauthAuthentication=function(t){e.initiateAuthentication(t)},f.logout=function(n){return r.post(e.makeRequestURL("/auth/logout")).then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");o.location.replace(n||"/")}).then(null,function(e){throw t.error(e),e})},f.loginLocal=function(n){t.debug("Login:",n.username);var o={username:n.username,password:n.password};return r.post(e.makeRequestURL("/auth/login"),o).then(u)},f.registerSocial=function(t){return r.put(e.makeRequestURL("/auth/user"),t).then(function(){return c()})},f.registerLocal=function(t){return r.post(e.makeRequestURL("/auth/user"),t)},f.checkUsernameAvailability=function(n){var o=e.makeRequestURL("/auth/usernameAvailable");return r.get(o,{params:{username:n}}).then(function(e){return"true"===e.data}).then(null,t.error)},f.resetPassword=function(t){return r.post(e.makeRequestURL("/forgot"),{email:t})},f.setNewPassword=function(t,n){return r.post(e.makeRequestURL("/reset/"+n),{password:t})},f.setRegistrationHanler=function(e){d=e},f.getStatusPromise=function(){return l||(l=c()),l},f.whenStatusIsKnown=f.getStatusPromise,f.init=function(t){return f.debug=t.debug||{},e.setBaseUrl(t.baseUrl),f.getStatusPromise()},f}]);